#!/bin/bash

# Concept pomodoro 26 min -- 8 min 30 sec

mkdir -p ~/.local/state/pmdr && cp ~/.config/pmdr/skel.md ~/.local/state/pmdr/suivi.md
alacritty -e nvim ~/.local/state/pmdr/suivi.md &
sleep 0.2
swaymsg [con_id=$(swaymsg -t get_tree | jq '.. | select(.type?) | select(.focused==true) | .id')] move scratchpad && swaymsg scratchpad show

wait

notify-send "PMDR" "Début de la session de travail..."

fs="   [WORK]   "

while ! [[ -z "$fs" ]] ; do
    echo -e "$fs\n$fs\n#04060a\n#f2cf66" >"$XDG_RUNTIME_DIR"/pfull
    echo -e "$es\n$es" >"$XDG_RUNTIME_DIR"/pempt
    pgrep i3blocks >/dev/null && pkill -SIGRTMIN+13 i3blocks
    for ((sec=0;sec<130;sec++)); do
        sleep 1
    done
    trof=$((${#fs}-1))
    es=${fs:$trof}$es
    fs=${fs::-1}
done

alacritty -e nvim ~/.local/state/pmdr/suivi.md &
sleep 0.2
swaymsg [con_id=$(swaymsg -t get_tree | jq '.. | select(.type?) | select(.focused==true) | .id')] move scratchpad && swaymsg scratchpad show

wait

cp .local/status/pmdr/suivi.md documents/pmdr_$(date +%d-%m-%Y_%H%M).md

notify-send "PMDR" "Fin de la session de travail.\nDébut de la pause..."

fs="   [PAUS]   "
es=""

while ! [[ -z "$fs" ]] ; do
    echo -e "$fs\n$fs\n#04060a\n#69a1cf" >"$XDG_RUNTIME_DIR"/pfull
    echo -e "$es\n$es" >"$XDG_RUNTIME_DIR"/pempt
    pgrep i3blocks >/dev/null && pkill -SIGRTMIN+13 i3blocks
    for ((sec=0;sec<85;sec++)); do
        sleep 0.5
    done
    trof=$((${#fs}-1))
    es=${fs:$trof}$es
    fs=${fs::-1}
done

fs="   [PMDR]   "
echo -e "$fs\n$fs\n#04060a\n#77bab1" >"$XDG_RUNTIME_DIR"/pfull
>"$XDG_RUNTIME_DIR"/pempt
pgrep i3blocks >/dev/null && pkill -SIGRTMIN+13 i3blocks

exit 0
